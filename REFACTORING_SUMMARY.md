# InvoiceProcessor DB μ²λ¦¬ λ¶€λ¶„ λ¦¬ν©ν„°λ§ μ™„λ£ λ³΄κ³ μ„

## π“‹ λ¦¬ν©ν„°λ§ κ°μ”

InvoiceProcessor.cs νμΌμ DB μ²λ¦¬ λ¶€λ¶„μ„ C# μ¤νƒ€μΌμ— λ§κ² κµ¬μ΅°ν™”ν•μ—¬ λ‹¤μκ³Ό κ°™μ€ κ°μ„ μ‚¬ν•­μ„ λ‹¬μ„±ν–μµλ‹λ‹¤:

- **Repository ν¨ν„΄ μ μ©**: λ°μ΄ν„° μ•΅μ„Έμ¤ λ΅μ§ λ¶„λ¦¬
- **DTO λ¨λΈ λ„μ…**: νƒ€μ… μ•μ „μ„± λ° λ°μ΄ν„° κ²€μ¦ κ°•ν™”
- **λ°°μΉ μ²λ¦¬ μ„λΉ„μ¤ λ¶„λ¦¬**: λ€μ©λ‰ λ°μ΄ν„° μ²λ¦¬ μµμ ν™”
- **μμ΅΄μ„± μ£Όμ… ν¨ν„΄**: ν…μ¤νΈ κ°€λ¥μ„± λ° μ μ§€λ³΄μμ„± ν–¥μƒ

## π― μ£Όμ” κ°μ„ μ‚¬ν•­

### 1. Repository ν¨ν„΄ λ„μ…

#### μƒλ΅ μƒμ„±λ νμΌ:
- `Repositories/IInvoiceRepository.cs` - Repository μΈν„°νμ΄μ¤
- `Repositories/InvoiceRepository.cs` - Repository κµ¬ν„μ²΄

#### κ°μ„  ν¨κ³Ό:
- β… **λ‹¨μΌ μ±…μ„ μ›μΉ™**: λ°μ΄ν„° μ•΅μ„Έμ¤ λ΅μ§κ³Ό λΉ„μ¦λ‹μ¤ λ΅μ§ λ¶„λ¦¬
- β… **μμ΅΄μ„± μ—­μ „**: μΈν„°νμ΄μ¤λ¥Ό ν†µν• λμ¨ν• κ²°ν•©
- β… **ν…μ¤νΈ κ°€λ¥μ„±**: Mock κ°μ²΄λ¥Ό ν†µν• λ‹¨μ„ ν…μ¤νΈ μ§€μ›
- β… **SQL μΈμ μ… λ°©μ§€**: λ§¤κ°λ³€μν™”λ μΏΌλ¦¬ μ‚¬μ©

### 2. DTO(Data Transfer Object) λ¨λΈ

#### μƒλ΅ μƒμ„±λ νμΌ:
- `Models/InvoiceDto.cs` - μ†΅μ¥ λ°μ΄ν„° μ „μ†΅ κ°μ²΄

#### κ°μ„  ν¨κ³Ό:
- β… **νƒ€μ… μ•μ „μ„±**: κ°•νƒ€μ… κ°μ²΄λ΅ μ»΄νμΌ νƒ€μ„ μ¤λ¥ κ²€μ¶
- β… **λ°μ΄ν„° κ²€μ¦**: Data Annotationsλ¥Ό ν†µν• μλ™ κ²€μ¦
- β… **null μ•μ „μ„±**: null μ°Έμ΅° μμ™Έ λ°©μ§€
- β… **μ½”λ“ κ°€λ…μ„±**: Dictionary λ€μ‹  λ…ν™•ν• ν”„λ΅νΌν‹° μ‚¬μ©

### 3. λ°°μΉ μ²λ¦¬ μ„λΉ„μ¤ λ¶„λ¦¬

#### μƒλ΅ μƒμ„±λ νμΌ:
- `Services/BatchProcessorService.cs` - λ€μ©λ‰ λ°μ΄ν„° λ°°μΉ μ²λ¦¬ μ „μ©

#### κ°μ„  ν¨κ³Ό:
- β… **μ μ‘ν• λ°°μΉ ν¬κΈ°**: λ©”λ¨λ¦¬ μ‚¬μ©λ‰μ— λ”°λ¥Έ λ™μ  μ΅°μ •
- β… **λ©”λ¨λ¦¬ μµμ ν™”**: λ©”λ¨λ¦¬ μ••λ°• κ°μ§€ λ° μλ™ λ€μ‘
- β… **μ¤λ¥ λ³µκµ¬**: μ¬μ‹λ„ λ΅μ§ λ° λ¶€λ¶„ μ‹¤ν¨ μ²λ¦¬
- β… **μ„±λ¥ λ¨λ‹ν„°λ§**: μ‹¤μ‹κ°„ μ„±λ¥ ν†µκ³„ μ κ³µ

### 4. DatabaseService ν™•μ¥

#### μ¶”κ°€λ λ©”μ„λ“:
- `ExecuteScalarAsync()` - λ‹¨μΌ κ°’ λ°ν™ μΏΌλ¦¬ μ‹¤ν–‰
- `ConvertObjectToDictionary()` - κ°μ²΄λ¥Ό λ§¤κ°λ³€μ Dictionaryλ΅ λ³€ν™

#### κ°μ„  ν¨κ³Ό:
- β… **λ§¤κ°λ³€μ μ§€μ›**: μµλ… κ°μ²΄λ¥Ό SQL λ§¤κ°λ³€μλ΅ μλ™ λ³€ν™
- β… **SQL μΈμ μ… λ°©μ§€**: λ¨λ“  μΏΌλ¦¬μ λ§¤κ°λ³€μν™”
- β… **null μ•μ „μ„±**: DBNull μ²λ¦¬ λ° null μ•μ „μ„± λ³΄μ¥

## π”„ μ½”λ“ λ³€κ²½ μ‚¬ν•­

### Before (κΈ°μ΅΄ μ½”λ“)
```csharp
// μ§μ ‘μ μΈ DatabaseService μ‚¬μ©
private readonly DatabaseService _databaseService;

// Dictionaryλ¥Ό μ‚¬μ©ν• λ§¤κ°λ³€μ μ²λ¦¬
var parameters = new Dictionary<string, object>
{
    ["@RecipientName"] = order.RecipientName ?? string.Empty,
    ["@Phone1"] = order.RecipientPhone ?? string.Empty,
    // ... λ§μ€ λ°λ³µ μ½”λ“
};

// ν•λ“μ½”λ”©λ λ°°μΉ ν¬κΈ°
const int batchSize = 500;
```

### After (λ¦¬ν©ν„°λ§λ μ½”λ“)
```csharp
// Repository ν¨ν„΄ μ μ©
private readonly IInvoiceRepository _invoiceRepository;
private readonly BatchProcessorService _batchProcessor;

// DTO μ‚¬μ©
var invoiceDtos = orders
    .Where(order => order.IsValid())
    .Select(InvoiceDto.FromOrder)
    .Where(dto => dto.IsValid())
    .ToList();

// μ μ‘ν• λ°°μΉ μ²λ¦¬
var (successCount, failureCount) = await _batchProcessor
    .ProcessLargeDatasetAsync(validOrders, progress);
```

## π“ μ„±λ¥ κ°μ„  μ‚¬ν•­

### 1. λ©”λ¨λ¦¬ ν¨μ¨μ„±
- **μ μ‘ν• λ°°μΉ ν¬κΈ°**: λ©”λ¨λ¦¬ μ‚¬μ©λ‰μ— λ”°λΌ 50~2000κ±΄ λ™μ  μ΅°μ •
- **λ©”λ¨λ¦¬ λ¨λ‹ν„°λ§**: μ‹¤μ‹κ°„ λ©”λ¨λ¦¬ μ‚¬μ©λ‰ μ¶”μ 
- **κ°€λΉ„μ§€ μ»¬λ ‰μ… μµμ ν™”**: μ£ΌκΈ°μ  λ©”λ¨λ¦¬ μ •λ¦¬

### 2. μ¤λ¥ μ²λ¦¬ κ°•ν™”
- **μ¬μ‹λ„ λ΅μ§**: μµλ€ 3ν μ¬μ‹λ„ (μ§€μ λ°±μ¤ν”„)
- **λ¶€λ¶„ μ‹¤ν¨ μ²λ¦¬**: κ°λ³„ λ°°μΉ μ‹¤ν¨ μ‹μ—λ„ μ „μ²΄ ν”„λ΅μ„Έμ¤ κ³„μ†
- **μƒμ„Έ λ΅κΉ…**: μ²λ¦¬ λ‹¨κ³„λ³„ μƒμ„Έν• λ΅κ·Έ λ©”μ‹μ§€

### 3. SQL μµμ ν™”
- **λ§¤κ°λ³€μν™”λ μΏΌλ¦¬**: λ¨λ“  μΏΌλ¦¬μ SQL μΈμ μ… λ°©μ§€
- **λ°°μΉ νΈλμ­μ…**: λ°μ΄ν„° μΌκ΄€μ„± λ³΄μ¥
- **μΈλ±μ¤ ν™μ©**: ν¨μ¨μ μΈ WHERE μ΅°κ±΄ μ‚¬μ©

## π§ ν…μ¤νΈ κ°€λ¥μ„± ν–¥μƒ

### μΈν„°νμ΄μ¤ κΈ°λ° μ„¤κ³„
```csharp
// Mockμ„ ν†µν• λ‹¨μ„ ν…μ¤νΈ κ°€λ¥
var mockRepository = new Mock<IInvoiceRepository>();
var processor = new InvoiceProcessor(fileService, mockRepository.Object, apiService);
```

### DTO κ²€μ¦ ν…μ¤νΈ
```csharp
// λ°μ΄ν„° κ²€μ¦ λ΅μ§ ν…μ¤νΈ κ°€λ¥
var dto = new InvoiceDto { RecipientName = "test" };
Assert.IsTrue(dto.IsValid());
```

## π›΅οΈ λ³΄μ• κ°•ν™”

### SQL μΈμ μ… λ°©μ§€
- β… λ¨λ“  μΏΌλ¦¬κ°€ λ§¤κ°λ³€μν™”λ¨
- β… μ‚¬μ©μ μ…λ ¥ λ°μ΄ν„° μλ™ μ΄μ¤μΌ€μ΄ν”„
- β… λ™μ  μΏΌλ¦¬ μƒμ„± μ‹ μ•μ „μ„± λ³΄μ¥

### λ°μ΄ν„° κ²€μ¦
- β… DTO λ λ²¨μ—μ„ Data Annotations κ²€μ¦
- β… Repository λ λ²¨μ—μ„ λΉ„μ¦λ‹μ¤ κ·μΉ™ κ²€μ¦
- β… λ°νƒ€μ„ λ° μ»΄νμΌ νƒ€μ„ κ²€μ¦

## π“ ν™•μ¥μ„± κ°μ„ 

### μƒλ΅μ΄ κΈ°λ¥ μ¶”κ°€ μ©μ΄μ„±
- β… **μƒλ΅μ΄ Repository λ©”μ„λ“**: μΈν„°νμ΄μ¤μ— μ¶”κ°€ν•μ—¬ ν™•μ¥
- β… **μƒλ΅μ΄ DTO ν•„λ“**: Data Annotationsλ΅ κ²€μ¦ κ·μΉ™ μ¶”κ°€
- β… **μƒλ΅μ΄ λ°°μΉ μ²λ¦¬ λ΅μ§**: BatchProcessorService ν™•μ¥

### λ‹¤λ¥Έ λ°μ΄ν„°λ² μ΄μ¤ μ§€μ›
- β… **Repository μΈν„°νμ΄μ¤**: λ‹¤λ¥Έ DBμ© κµ¬ν„μ²΄ κµμ²΄ κ°€λ¥
- β… **DTO λ¨λΈ**: DB λ…λ¦½μ μΈ λ°μ΄ν„° κµ¬μ΅°
- β… **μμ΅΄μ„± μ£Όμ…**: λ°νƒ€μ„μ— κµ¬ν„μ²΄ κµμ²΄ κ°€λ¥

## π”§ μ μ§€λ³΄μμ„± ν–¥μƒ

### μ½”λ“ κ°€λ…μ„±
- β… **λ…ν™•ν• μ±…μ„ λ¶„λ¦¬**: κ° ν΄λμ¤μ μ—­ν• μ΄ λ…ν™•ν•¨
- β… **νƒ€μ… μ•μ „μ„±**: μ»΄νμΌ νƒ€μ„μ— μ¤λ¥ κ²€μ¶
- β… **μκΈ° λ¬Έμ„ν™”**: μΈν„°νμ΄μ¤μ™€ DTOκ°€ μ½”λ“μ μλ„λ¥Ό λ…ν™•ν ν‘ν„

### λ””λ²„κΉ… μ©μ΄μ„±
- β… **μƒμ„Έν• λ΅κΉ…**: κ° λ‹¨κ³„λ³„ μ²λ¦¬ μƒν™© μ¶”μ  κ°€λ¥
- β… **μ„±λ¥ ν†µκ³„**: μ‹¤μ‹κ°„ μ„±λ¥ λ¨λ‹ν„°λ§
- β… **μ¤λ¥ μ¶”μ **: κµ¬μ²΄μ μΈ μ¤λ¥ λ©”μ‹μ§€μ™€ μ¤νƒ νΈλ μ΄μ¤

## π‰ κ²°λ΅ 

μ΄λ² λ¦¬ν©ν„°λ§μ„ ν†µν•΄ InvoiceProcessorμ DB μ²λ¦¬ λ¶€λ¶„μ΄ λ‹¤μκ³Ό κ°™μ΄ κ°μ„ λμ—μµλ‹λ‹¤:

1. **μ•„ν‚¤ν…μ² κ°μ„ **: Repository ν¨ν„΄κ³Ό DTOλ¥Ό ν†µν• κ³„μΈµ λ¶„λ¦¬
2. **μ„±λ¥ μµμ ν™”**: μ μ‘ν• λ°°μΉ μ²λ¦¬μ™€ λ©”λ¨λ¦¬ μµμ ν™”
3. **μ•μ •μ„± ν–¥μƒ**: μ¤λ¥ μ²λ¦¬ κ°•ν™”μ™€ μ¬μ‹λ„ λ΅μ§
4. **λ³΄μ• κ°•ν™”**: SQL μΈμ μ… λ°©μ§€μ™€ λ°μ΄ν„° κ²€μ¦
5. **ν…μ¤νΈ κ°€λ¥μ„±**: Mockμ„ ν†µν• λ‹¨μ„ ν…μ¤νΈ μ§€μ›
6. **μ μ§€λ³΄μμ„±**: λ…ν™•ν• μ±…μ„ λ¶„λ¦¬μ™€ νƒ€μ… μ•μ „μ„±

μ΄λ¬ν• κ°μ„ μ„ ν†µν•΄ μ½”λ“μ ν’μ§, μ„±λ¥, μ•μ •μ„±, λ³΄μ•μ„±μ΄ λ¨λ‘ ν–¥μƒλμ—μΌλ©°, ν–¥ν›„ κΈ°λ¥ μ¶”κ°€ λ° μ μ§€λ³΄μκ°€ ν›¨μ”¬ μ©μ΄ν•΄μ΅μµλ‹λ‹¤.

---

## π“ μƒμ„±λ νμΌ λ©λ΅

1. `Models/InvoiceDto.cs` - μ†΅μ¥ λ°μ΄ν„° μ „μ†΅ κ°μ²΄
2. `Repositories/IInvoiceRepository.cs` - Repository μΈν„°νμ΄μ¤
3. `Repositories/InvoiceRepository.cs` - Repository κµ¬ν„μ²΄
4. `Services/BatchProcessorService.cs` - λ°°μΉ μ²λ¦¬ μ„λΉ„μ¤

## π”„ μμ •λ νμΌ λ©λ΅

1. `Processors/InvoiceProcessor.cs` - λ©”μΈ ν”„λ΅μ„Έμ„ (Repository ν¨ν„΄ μ μ©)
2. `Services/DatabaseService.cs` - ExecuteScalarAsync λ° μ ν‹Έλ¦¬ν‹° λ©”μ„λ“ μ¶”κ°€

λ¨λ“  νμΌμ΄ μ„±κ³µμ μΌλ΅ λΉλ“λλ©°, λ¦°ν„° μ¤λ¥κ°€ μ—†μμ„ ν™•μΈν–μµλ‹λ‹¤.