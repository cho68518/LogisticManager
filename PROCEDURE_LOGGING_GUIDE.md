# 프로시저 로깅 시스템 사용 가이드

## 🎯 개요

이 시스템은 `sp_ProcessStarInvoice` 프로시저의 실행 결과를 상세하게 로깅하고 `app.log` 파일에 저장하는 기능을 제공합니다.

## 📁 생성된 파일들

### 1. `Services/ProcedureLogService.cs`
- 프로시저 실행 로그를 관리하는 핵심 서비스
- 각 단계별 처리 건수와 실행 시간 기록
- 구조화된 로그 형태로 파일 저장

### 2. `Services/SeoulProcessProcedureService.cs`
- 서울 프로세스 프로시저 전용 실행 서비스
- 프로시저 실행 및 로그 수집 담당
- 성능 모니터링 및 에러 처리

### 3. `Forms/SeoulProcessTestForm.cs`
- 프로시저 실행을 테스트할 수 있는 Windows 폼
- 실행 결과 실시간 확인
- 로그 파일 상태 및 내용 확인

## 🚀 사용 방법

### 기본 사용법

```csharp
// 서비스 초기화
var logService = new LogManagementService();
var procedureLogService = new ProcedureLogService(logService);
var databaseService = new DatabaseService(); // 실제 구현에 맞게 수정
var seoulProcessService = new SeoulProcessProcedureService(
    databaseService, 
    procedureLogService, 
    logService
);

// 프로시저 실행 (동기)
var result = seoulProcessService.ExecuteSeoulProcessProcedure();

// 프로시저 실행 (비동기)
var result = await seoulProcessService.ExecuteSeoulProcessProcedureAsync();
```

### 로그 확인

```csharp
// 로그 파일 상태 확인
var (exists, sizeBytes, sizeMB) = logService.GetLogFileSizeInfo();

// 로그 파일 열기
System.Diagnostics.Process.Start("notepad.exe", logService.LogFilePath);
```

## 📊 로그 출력 예시

```
====================================================================================================
🚀 프로시저 실행 시작: sp_ProcessStarInvoice
⏰ 시작 시간: 2024-01-15 14:30:25.123
⏱️  총 실행 시간: 45.234초
📊 총 단계 수: 29
📈 총 처리 행 수: 15,234
✅ 실행 결과: 성공
----------------------------------------------------------------------------------------------------
📋 단계별 실행 상세:
단계 처리내용                                        처리행수   실행시간    
--------------------------------------------------------------------------------
1    관리자 테이블 3개 초기화 (TRUNCATE)            0         N/A         
2    [INSERT] 관리자_품절제품코드/상품명            1,234     N/A         
3    [INSERT] 관리자_배송메세지                     567       N/A         
4    [INSERT] 관리자_수취인명                       890       N/A         
5    [UPDATE] 배송메세지 별표 제거                  234       N/A         
...
----------------------------------------------------------------------------------------------------
🏁 프로시저 실행 완료: sp_ProcessStarInvoice
⏰ 완료 시간: 2024-01-15 14:31:10.357
====================================================================================================
```

## 🔧 주요 기능

### 1. 단계별 로깅
- 29개 처리 단계의 모든 정보 기록
- 각 단계별 처리된 행 수 추적
- 실행 시간 측정 및 성능 분석

### 2. 자동 로그 관리
- 로그 파일 크기 자동 모니터링 (200MB 임계값)
- 임계값 초과 시 자동 백업 및 클리어
- 스레드 안전한 로그 기록

### 3. 에러 처리
- 프로시저 실행 실패 시 상세한 오류 정보 기록
- 데이터베이스 연결 오류 및 SQL 예외 처리
- 롤백 상황에 대한 로그 기록

### 4. 성능 모니터링
- 전체 실행 시간 측정
- 단계별 처리 건수 통계
- 성능 병목 지점 식별

## 📋 프로시저 단계 목록

1. **관리자 테이블 초기화** - TRUNCATE 작업
2. **품절제품코드/상품명 INSERT** - 별표송장에서 데이터 복사
3. **배송메세지 INSERT** - 별표송장에서 배송메세지 복사
4. **수취인명 INSERT** - 별표송장에서 수취인명 복사
5. **배송메세지 별표 제거** - ★ 문자 제거
6. **별표 품목코드 입력** - 품목코드 매칭으로 ★★★ 설정
7. **배송메세지 검색으로 별표 입력** - FULLTEXT 검색으로 ★★★ 설정
8. **별표 수취인 입력** - 수취인명 매칭으로 ★★★ 설정
9. **제주도 주소 표시** - 제주 주소에 '제주' 표시
10. **별표 고객 공통 마킹** - 주소+수취인명 기준 공통 마킹
11. **박스상품 명칭 변경** - 박스 상품명 앞에 '▨▧▦ ' 추가
12. **택배 박스/낱개 구분** - 수량 기준으로 박스/낱개 구분
13. **송장구분최종 설정** - 송장구분 + 택배수량1 결합
14. **냉동 렉 위치 입력** - 품목등록 테이블과 JOIN하여 위치 설정
15. **빈 위치를 99-1로 설정** - NULL/빈 위치값 처리
16. **위치변환 설정** - 위치별 형식에 따른 변환값 생성
17. **합포장 처리 (공3)** - 공2 위치의 특정 수량 범위 처리
18. **냉동창고 공산품 송장분리** - 공2 위치 주소에 ☆ 추가
19. **공통박스 테이블 초기화** - TRUNCATE 작업
20. **공통박스 데이터 복사** - 박스 상품 데이터 복사
21. **박스 수량만큼 행 복사** - Numbers 테이블 활용한 행 복제
22. **박스주문 순번 매기기 1** - 위치변환 기준 순번 부여
23. **박스주문 주소에 순번 추가** - 주소에 순번 정보 추가
24. **박스주문 순번 매기기 2** - 주소 기준 중복 순번 처리
25. **박스주문 수량을 1로 변경** - 모든 박스 주문 수량을 1로 설정
26. **박스주문 위치변환 재설정** - 박스 주문용 위치변환값 재생성
27. **공통박스 품목개수 합산** - 품목코드별 수량 합산
28. **개별작업 1 (서울낱개/서울박스)** - 서울 지역 특별 처리
29. **개별작업 2 (공통박스 → 서울박스)** - 공통박스 서울 지역 처리

## 🎨 테스트 폼 사용법

1. **로그 파일 상태 확인**
   - 로그 파일 경로 및 크기 정보 표시
   - 상태 새로고침 버튼으로 실시간 정보 업데이트

2. **프로시저 실행**
   - 동기 실행: UI가 블록되지 않는 동기 방식
   - 비동기 실행: 백그라운드에서 실행되는 비동기 방식

3. **실행 결과 확인**
   - 성공/실패 여부
   - 총 실행 시간 및 단계 수
   - 각 단계별 처리 건수

4. **로그 내용 확인**
   - app.log 파일의 전체 내용 표시
   - 로그 새로고침으로 최신 내용 확인

## ⚠️ 주의사항

1. **DatabaseService 구현 필요**
   - `SeoulProcessTestForm.cs`의 DatabaseService 인스턴스화 부분을 실제 구현에 맞게 수정해야 합니다.

2. **데이터베이스 연결 설정**
   - 프로시저 실행을 위한 데이터베이스 연결 문자열이 올바르게 설정되어야 합니다.

3. **권한 확인**
   - 프로시저 실행을 위한 적절한 데이터베이스 권한이 필요합니다.

4. **로그 파일 경로**
   - `LogPathManager.AppLogPath`가 올바른 경로를 가리키는지 확인하세요.

## 🔍 문제 해결

### 로그 파일이 생성되지 않는 경우
1. `LogPathManager.AppLogPath` 경로 확인
2. 해당 디렉토리에 쓰기 권한 확인
3. `LogManagementService` 인스턴스 생성 확인

### 프로시저 실행이 실패하는 경우
1. 데이터베이스 연결 상태 확인
2. 프로시저 존재 여부 확인
3. 데이터베이스 권한 확인
4. `app.log` 파일에서 상세한 오류 메시지 확인

### 성능 문제가 발생하는 경우
1. 각 단계별 실행 시간 분석
2. 처리 건수가 많은 단계 식별
3. 데이터베이스 인덱스 최적화 검토
4. 프로시저 내 쿼리 성능 분석

## 📈 향후 개선 방안

1. **실시간 모니터링**
   - 웹 대시보드를 통한 실시간 프로시저 실행 현황 모니터링

2. **알림 시스템**
   - 특정 임계값 초과 시 이메일/SMS 알림

3. **성능 분석 도구**
   - 실행 시간 히스토리 분석
   - 성능 트렌드 차트

4. **자동화**
   - 정기적인 프로시저 실행 스케줄링
   - 실패 시 자동 재시도

5. **백업 및 복구**
   - 로그 데이터베이스 저장
   - 장기 보관 및 검색 기능
