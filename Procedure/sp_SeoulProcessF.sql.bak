DELIMITER $$

DROP PROCEDURE IF EXISTS sp_SeoulProcessF$$

CREATE PROCEDURE sp_SeoulProcessF()
BEGIN
    /*--================================================================================
	-- 서울냉동 처리
    --================================================================================*/

    DECLARE done INT DEFAULT FALSE;

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

    -- EXIT: 핸들러 실행 후 프로시저 종료
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        SELECT '오류가 발생하여 모든 작업이 롤백되었습니다.' AS ErrorMessage;
    END;

    START TRANSACTION;

    /*--================================================================================
	-- (서울냉동) 서울서울낱개 분류
    --================================================================================*/
	TRUNCATE TABLE 송장출력_서울냉동변환;
	
	INSERT INTO 송장출력_서울냉동변환 
	           (msg1, msg2, msg3, msg4, msg5, msg6, 수취인명, 전화번호1, 전화번호2, 우편번호, 
	            주소, 옵션명, 수량, 배송메세지, 주문번호, 쇼핑몰, 수집시간, 송장명, 품목코드, 
				택배비용, 박스크기, 출력개수, 송장수량, 별표1, 별표2, 품목개수, 택배수량, 택배수량1, 
				택배수량합산, 송장구분자, 송장구분, 송장구분최종, 위치, 위치변환)
         SELECT msg1, msg2, msg3, msg4, msg5, msg6, 수취인명, 전화번호1, 전화번호2, 우편번호, 
		        주소, 옵션명, 수량, 배송메세지, 주문번호, 쇼핑몰, 수집시간, 송장명, 품목코드, 
				택배비용, 박스크기, 출력개수, 송장수량, 별표1, 별표2, 품목개수, 택배수량, 택배수량1, 
				택배수량합산, 송장구분자, 송장구분, 송장구분최종, 위치, 위치변환
           FROM 송장출력_사방넷원본변환_Dev
          WHERE 송장구분최종 = '서울낱개';
	
    /*--================================================================================
	-- (서울냉동) 택배수량 계산 및 송장구분자 업데이트
    --================================================================================*/
	UPDATE 송장출력_서울냉동변환
       SET 송장구분자 = FLOOR((1 / IFNULL(NULLIF(택배수량, 0), 10)) * 1000) / 1000;
	   
    /*--================================================================================
	-- (서울냉동) 송장구분자와 수량 곱 업데이트
    --================================================================================*/
	UPDATE 송장출력_서울냉동변환
       SET 송장구분자 = 송장구분자 * 수량;
	   
    /*--================================================================================
	-- (서울냉동) 주소 + 수취인명 기반 송장구분자 합산
    --================================================================================*/
	UPDATE 송장출력_서울냉동변환 AS t
      JOIN (
            SELECT 주소, 수취인명, SUM(송장구분자) AS 구분자합
              FROM 송장출력_서울냉동변환
          GROUP BY 주소, 수취인명
        ) AS s ON t.주소 = s.주소 AND t.수취인명 = s.수취인명
       SET t.택배수량1 = s.구분자합;
	
    /*--================================================================================
	-- (서울냉동) 택배수량1 올림 처리
    --================================================================================*/
	UPDATE 송장출력_서울냉동변환
       SET 택배수량1 = CEIL(IFNULL(택배수량1, 1));

    /*--================================================================================
	-- (서울냉동) 택배수량1에 따른 송장구분 업데이트
    --================================================================================*/
	UPDATE 송장출력_서울냉동변환
       SET 송장구분 = CASE WHEN 택배수량1 > 1 THEN '추가' ELSE '1장' END;
	
    /*--================================================================================
	-- (서울냉동) 주소 및 수취인명 유일성에 따른 송장구분 업데이트 시작
    --================================================================================*/
    UPDATE 송장출력_서울냉동변환 t1
      JOIN (
            SELECT 주소, 수취인명
              FROM 송장출력_서울냉동변환
             WHERE 송장구분 = '1장'
          GROUP BY 주소, 수취인명
            HAVING COUNT(*) = 1
        ) AS unique_address ON t1.주소 = unique_address.주소 AND t1.수취인명 = unique_address.수취인명
       SET t1.송장구분 = '단일'
     WHERE t1.송장구분 = '1장';
		
    /*--================================================================================
	-- (서울냉동) 서울냉동1장 분류
    --================================================================================*/
	TRUNCATE TABLE 송장출력_서울냉동1장;
	
	INSERT INTO 송장출력_서울냉동1장 
	           (msg1, msg2, msg3, msg4, msg5, msg6, 수취인명, 전화번호1, 전화번호2, 우편번호, 
	            주소, 옵션명, 수량, 배송메세지, 주문번호, 쇼핑몰, 수집시간, 송장명, 품목코드, 
				택배비용, 박스크기, 출력개수, 송장수량, 별표1, 별표2, 품목개수, 택배수량, 
				택배수량1, 택배수량합산, 송장구분자, 송장구분, 송장구분최종, 위치, 위치변환)
         SELECT msg1, msg2, msg3, msg4, msg5, msg6, 수취인명, 전화번호1, 전화번호2, 우편번호, 
		        주소, 옵션명, 수량, 배송메세지, 주문번호, 쇼핑몰, 수집시간, 송장명, 품목코드, 
				택배비용, 박스크기, 출력개수, 송장수량, 별표1, 별표2, 품목개수, 택배수량, 
				택배수량1, 택배수량합산, 송장구분자, 송장구분, 송장구분최종, 위치, 위치변환
           FROM 송장출력_서울냉동변환
          WHERE 송장구분 = '1장';
    -- ORDER BY 제거
	   
    /*--================================================================================
	-- (서울냉동) 서울냉동 단일 분류
    --================================================================================*/
	TRUNCATE TABLE 송장출력_서울냉동단일;
	
    INSERT INTO 송장출력_서울냉동단일 
	           (msg1, msg2, msg3, msg4, msg5, msg6, 수취인명, 전화번호1, 전화번호2, 우편번호, 
	            주소, 옵션명, 수량, 배송메세지, 주문번호, 쇼핑몰, 수집시간, 송장명, 품목코드, 
			    택배비용, 박스크기, 출력개수, 송장수량, 별표1, 별표2, 품목개수, 택배수량, 
				택배수량1, 택배수량합산, 송장구분자, 송장구분, 송장구분최종, 위치, 위치변환)
         SELECT msg1, msg2, msg3, msg4, msg5, msg6, 수취인명, 전화번호1, 전화번호2, 우편번호, 
		        주소, 옵션명, 수량, 배송메세지, 주문번호, 쇼핑몰, 수집시간, 송장명, 품목코드, 
				택배비용, 박스크기, 출력개수, 송장수량, 별표1, 별표2, 품목개수, 택배수량, 
				택배수량1, 택배수량합산, 송장구분자, 송장구분, 송장구분최종, 위치, 위치변환
           FROM 송장출력_서울냉동변환
          WHERE 송장구분 = '단일';
    -- ORDER BY 제거
	
    /*--================================================================================
	-- (서울냉동) 품목코드별 수량 합산 및 품목개수
    --================================================================================*/
    UPDATE 송장출력_서울냉동단일 AS t1 
    INNER JOIN (
            SELECT 품목코드, SUM(수량) AS total_quantity
              FROM 송장출력_서울냉동단일
          GROUP BY 품목코드
        ) AS t2 ON t1.품목코드 = t2.품목코드
       SET t1.품목개수 = t2.total_quantity;
		
    /*--================================================================================
	-- (서울냉동) 서울냉동 추가 분류
    --================================================================================*/
	TRUNCATE TABLE 송장출력_서울냉동추가;
	
    INSERT INTO 송장출력_서울냉동추가 
	           (msg1, msg2, msg3, msg4, msg5, msg6, 수취인명, 전화번호1, 전화번호2, 우편번호, 
	            주소, 옵션명, 수량, 배송메세지, 주문번호, 쇼핑몰, 수집시간, 송장명, 품목코드, 
				택배비용, 박스크기, 출력개수, 송장수량, 별표1, 별표2, 품목개수, 택배수량, 
				택배수량1, 택배수량합산, 송장구분자, 송장구분, 송장구분최종, 위치, 위치변환)
         SELECT msg1, msg2, msg3, msg4, msg5, msg6, 수취인명, 전화번호1, 전화번호2, 우편번호, 
		        주소, 옵션명, 수량, 배송메세지, 주문번호, 쇼핑몰, 수집시간, 송장명, 품목코드, 
				택배비용, 박스크기, 출력개수, 송장수량, 별표1, 별표2, 품목개수, 택배수량, 
				택배수량1, 택배수량합산, 송장구분자, 송장구분, 송장구분최종, 위치, 위치변환
           FROM 송장출력_서울냉동변환
          WHERE 송장구분 = '추가';
    -- ORDER BY 제거
	   
    /*--================================================================================
	-- (서울냉동) 서울냉동추가송장 테이블로 유니크 주소 행 이동
    --================================================================================*/
	TRUNCATE TABLE 송장출력_서울냉동추가송장;
	
    -- ROW_NUMBER() 대신 GROUP BY, MIN(id) 사용
	INSERT INTO 송장출력_서울냉동추가송장 
	      (msg1, msg2, msg3, msg4, msg5, msg6, 수취인명, 전화번호1, 전화번호2, 우편번호, 
	       주소, 옵션명, 수량, 배송메세지, 주문번호, 쇼핑몰, 수집시간, 송장명, 품목코드, 
		   택배비용, 박스크기, 출력개수, 송장수량, 별표1, 별표2, 품목개수, 택배수량, 
		   택배수량1, 택배수량합산, 송장구분자, 송장구분, 송장구분최종, 위치, 위치변환)
    SELECT t1.msg1, t1.msg2, t1.msg3, t1.msg4, t1.msg5, t1.msg6, t1.수취인명, t1.전화번호1, t1.전화번호2, t1.우편번호, 
	       t1.주소, t1.옵션명, t1.수량, t1.배송메세지, t1.주문번호, t1.쇼핑몰, t1.수집시간, t1.송장명, t1.품목코드, 
		   t1.택배비용, t1.박스크기, t1.출력개수, t1.송장수량, t1.별표1, t1.별표2, t1.품목개수, t1.택배수량, 
		   t1.택배수량1, t1.택배수량합산, t1.송장구분자, t1.송장구분, t1.송장구분최종, t1.위치, t1.위치변환
      FROM 송장출력_서울냉동추가 AS t1
      JOIN (
          SELECT 주소, MIN(id) AS min_id
            FROM 송장출력_서울냉동추가
        GROUP BY 주소
      ) AS t2 ON t1.주소 = t2.주소 AND t1.id = t2.min_id;

    /*--================================================================================
	-- (서울냉동) 서울냉동추가송장 업데이트
    --================================================================================*/
	UPDATE 송장출력_서울냉동추가송장
       SET 수량 = 1, 송장명 = '+++', 옵션명 = '+++' , 품목코드 = '0000';

    /*--================================================================================
	-- (서울냉동) 서울냉동 추가송장 늘리기
    --================================================================================*/
	INSERT INTO 송장출력_서울냉동추가송장 
	       (msg1, msg2, msg3, msg4, msg5, msg6, 수취인명, 전화번호1, 전화번호2, 우편번호, 
	        주소, 옵션명, 수량, 배송메세지, 주문번호, 쇼핑몰, 수집시간, 송장명, 품목코드, 
			택배비용, 박스크기, 출력개수, 송장수량, 별표1, 별표2, 품목개수, 택배수량, 
			택배수량1, 택배수량합산, 송장구분자, 송장구분, 송장구분최종, 위치, 위치변환)
	SELECT t.msg1, t.msg2, t.msg3, t.msg4, t.msg5, t.msg6, t.수취인명, t.전화번호1, t.전화번호2, t.우편번호, 
	       t.주소, t.옵션명, t.수량, t.배송메세지, t.주문번호, t.쇼핑몰, t.수집시간, t.송장명, t.품목코드, 
		   t.택배비용, t.박스크기, t.출력개수, t.송장수량, t.별표1, t.별표2, t.품목개수, t.택배수량, 
		   t.택배수량1, t.택배수량합산, t.송장구분자, t.송장구분, t.송장구분최종, t.위치, t.위치변환
	  FROM 송장출력_서울냉동추가송장 AS t
	  JOIN Numbers AS n ON n.n <= (t.택배수량1 - 2)
	 WHERE t.택배수량1 > 2;
			
    /*--================================================================================
	-- (서울냉동) 서울냉동추가송장 순번 매기기
    --================================================================================*/
    UPDATE 송장출력_서울냉동추가송장 AS t
      JOIN (
            SELECT id, @seq := IF(@current_group = 위치변환, @seq + 1, 1) AS rn, @current_group := 위치변환
              FROM 송장출력_서울냉동추가송장, (SELECT @seq := 0, @current_group := '') AS vars
          ORDER BY 위치변환, id
        ) AS s ON t.id = s.id
       SET t.송장구분자 = CONCAT('[', s.rn, ']');
		
    /*--================================================================================
	-- (서울냉동) 서울냉동추가송장 주소업데이트
    --================================================================================*/
    UPDATE 송장출력_서울냉동추가송장 SET 주소 = CONCAT(주소, 송장구분자);
	
    /*--================================================================================
	-- (서울냉동) 서울냉동추가 합치기
    --================================================================================*/
    TRUNCATE TABLE 송장출력_서울냉동추가합치기;
	
	INSERT INTO 송장출력_서울냉동추가합치기
	           (msg1, msg2, msg3, msg4, msg5, msg6, 수취인명, 전화번호1, 전화번호2, 우편번호, 
			    주소, 옵션명, 수량, 배송메세지, 주문번호, 쇼핑몰, 수집시간, 송장명, 품목코드, 
				택배비용, 박스크기, 출력개수, 송장수량, 별표1, 별표2, 품목개수, 택배수량, 
				택배수량1, 택배수량합산, 송장구분자, 송장구분, 송장구분최종, 위치, 위치변환)
         SELECT msg1, msg2, msg3, msg4, msg5, msg6, 수취인명, 전화번호1, 전화번호2, 우편번호, 
		        주소, 옵션명, 수량, 배송메세지, 주문번호, 쇼핑몰, 수집시간, 송장명, 품목코드, 
				택배비용, 박스크기, 출력개수, 송장수량, 별표1, 별표2, 품목개수, 택배수량, 
				택배수량1, 택배수량합산, 송장구분자, 송장구분, 송장구분최종, 위치, 위치변환
           FROM (
              SELECT * FROM 송장출력_서울냉동추가
              UNION ALL
              SELECT * FROM 송장출력_서울냉동추가송장
           ) AS combined;
    -- ORDER BY 제거

    /*--================================================================================
	-- (서울냉동) 서울냉동 테이블 마지막정리
    --================================================================================*/
    TRUNCATE TABLE 송장출력_서울냉동;

    INSERT INTO 송장출력_서울냉동 
	           (msg1, msg2, msg3, msg4, msg5, msg6, 수취인명, 전화번호1, 전화번호2, 우편번호, 
	            주소, 옵션명, 수량, 배송메세지, 주문번호, 쇼핑몰, 수집시간, 송장명, 품목코드, 
				택배비용, 박스크기, 출력개수, 송장수량, 별표1, 별표2, 품목개수, 택배수량, 
				택배수량1, 택배수량합산, 송장구분자, 송장구분, 송장구분최종, 위치, 위치변환)
         SELECT msg1, msg2, msg3, msg4, msg5, msg6, 수취인명, 전화번호1, 전화번호2, 우편번호, 
		        주소, 옵션명, 수량, 배송메세지, 주문번호, 쇼핑몰, 수집시간, 송장명, 품목코드, 
				택배비용, 박스크기, 출력개수, 송장수량, 별표1, 별표2, 품목개수, 택배수량, 
				택배수량1, 택배수량합산, 송장구분자, 송장구분, 송장구분최종, 위치, 위치변환 
		   FROM 송장출력_서울냉동단일
		 UNION ALL
		 SELECT msg1, msg2, msg3, msg4, msg5, msg6, 수취인명, 전화번호1, 전화번호2, 우편번호, 
		        주소, 옵션명, 수량, 배송메세지, 주문번호, 쇼핑몰, 수집시간, 송장명, 품목코드, 
				택배비용, 박스크기, 출력개수, 송장수량, 별표1, 별표2, 품목개수, 택배수량, 
				택배수량1, 택배수량합산, 송장구분자, 송장구분, 송장구분최종, 위치, 위치변환 
		   FROM 송장출력_공통박스 
		  WHERE 송장구분최종 = '서울박스'
		 UNION ALL
		 SELECT msg1, msg2, msg3, msg4, msg5, msg6, 수취인명, 전화번호1, 전화번호2, 우편번호, 
		        주소, 옵션명, 수량, 배송메세지, 주문번호, 쇼핑몰, 수집시간, 송장명, 품목코드, 
				택배비용, 박스크기, 출력개수, 송장수량, 별표1, 별표2, 품목개수, 택배수량, 
				택배수량1, 택배수량합산, 송장구분자, 송장구분, 송장구분최종, 위치, 위치변환 
		   FROM 송장출력_서울냉동1장
		 UNION ALL
		 SELECT msg1, msg2, msg3, msg4, msg5, msg6, 수취인명, 전화번호1, 전화번호2, 우편번호, 
		        주소, 옵션명, 수량, 배송메세지, 주문번호, 쇼핑몰, 수집시간, 송장명, 품목코드, 
				택배비용, 박스크기, 출력개수, 송장수량, 별표1, 별표2, 품목개수, 택배수량, 
				택배수량1, 택배수량합산, 송장구분자, 송장구분, 송장구분최종, 위치, 위치변환 
		   FROM 송장출력_서울냉동추가합치기;
	
    /*--================================================================================
	-- (서울냉동) 별표 행 이동 및 삭제
    --================================================================================*/
    TRUNCATE TABLE 송장출력_서울냉동별표;
	
    INSERT INTO 송장출력_서울냉동별표
         SELECT * FROM 송장출력_서울냉동
          WHERE 별표1 <> '' OR 별표2 <> '';
	
    DELETE FROM 송장출력_서울냉동
          WHERE 별표1 <> '' OR 별표2 <> '';
	
    /*--================================================================================
	-- (서울냉동) 별표1 기준으로 정렬하여 행 이동
    --================================================================================*/
    INSERT INTO 송장출력_서울냉동
	           (msg1, msg2, msg3, msg4, msg5, msg6, 수취인명, 전화번호1, 전화번호2, 우편번호, 
	            주소, 옵션명, 수량, 배송메세지, 주문번호, 쇼핑몰, 수집시간, 송장명, 품목코드, 
				택배비용, 박스크기, 출력개수, 송장수량, 별표1, 별표2, 품목개수, 택배수량, 
				택배수량1, 택배수량합산, 송장구분자, 송장구분, 송장구분최종, 위치, 위치변환)
         SELECT msg1, msg2, msg3, msg4, msg5, msg6, 수취인명, 전화번호1, 전화번호2, 우편번호, 
		        주소, 옵션명, 수량, 배송메세지, 주문번호, 쇼핑몰, 수집시간, 송장명, 품목코드, 
				택배비용, 박스크기, 출력개수, 송장수량, 별표1, 별표2, 품목개수, 택배수량, 
				택배수량1, 택배수량합산, 송장구분자, 송장구분, 송장구분최종, 위치, 위치변환
           FROM 송장출력_서울냉동별표
       ORDER BY 주소 ASC, 옵션명 ASC;
		
    /*--================================================================================
	-- (서울냉동) 송장출력_서울냉동에서 송장출력_서울냉동_최종으로 데이터 이동
    --================================================================================*/
    TRUNCATE TABLE 송장출력_서울냉동_최종;
	
	INSERT INTO 송장출력_서울냉동_최종
	           (msg1, msg2, msg3, msg4, msg5, msg6, 수취인명, 전화번호1, 전화번호2, 우편번호, 
	            주소, 송장명, 수량, 배송메세지, 주문번호, 쇼핑몰, 품목코드, 
				택배비용, 박스크기, 출력개수, 별표1, 별표2, 품목개수)
         SELECT msg1, msg2, msg3, msg4, msg5, msg6, 수취인명, 전화번호1, 전화번호2, 우편번호, 
		        주소, 송장명, 수량, 배송메세지, 주문번호, 쇼핑몰, 품목코드, 
				택배비용, 박스크기, 출력개수, 별표1, 별표2, 품목개수
           FROM 송장출력_서울냉동;
		
    /*--================================================================================
	-- (서울냉동) 송장출력_서울냉동_최종 테이블 업데이트
    --================================================================================*/
    UPDATE 송장출력_서울냉동_최종
       SET 택배비용 = 2150, 박스크기 = '극소', 출력개수 = 1;
		
    COMMIT;
    SELECT '작업완료.' AS SuccessMessage;

END$$

DELIMITER ;